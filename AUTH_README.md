# Authentication and Authorization

This document details the implementation of the authentication and authorization system, including JWT, guards, strategies, and Two-Factor Authentication (2FA).

## Authentication Flow

```
                               +------------------+
                               |   User Client    |
                               +------------------+
                                        |
                                        | 1. Login with credentials
                                        | (email/password)
                                        v
+------------------+           +------------------+          +------------------+
|   Local Guard    | <-------- |   Auth Service   | -------> |  Local Strategy  |
| (Authenticates)  |           |  (Generates JWT) |          | (Validates User) |
+------------------+           +------------------+          +------------------+
         ^                              |
         |                              | 2. Returns JWT Token
         |                              |
         |                              v
         |                     +------------------+
         |                     |   User Client    |
         |                     +------------------+
         |                              |
         |                              | 3. Access protected route
         |                              |    with JWT in Header
         |                              v
+------------------+           +------------------+          +------------------+
|    JWT Guard     | <-------- |   Auth Service   | -------> |   JWT Strategy   |
|  (Authorizes)    |           | (Validates Token)|          |  (Extracts User) |
+------------------+           +------------------+          +------------------+
```

## Core Components

- **`AuthModule`**: Module that encapsulates all authentication logic.
- **`AuthService`**: Contains methods for validating users, generating JWT tokens, and managing 2FA.
- **`AuthController`**: Exposes endpoints for login, status, and 2FA management.
- **`LocalStrategy`**: Validates user credentials (email and password).
- **`JwtStrategy`**: Validates the JWT token on each protected request.

## Guards

- **`LocalAuthGuard`**: Activates the `LocalStrategy` on the login endpoint.
- **`JwtAuthGuard`**: Protects routes that require a valid JWT token.
- **`AdminGuard`**: Ensures that only users with the `admin` role can access the route.

## API Endpoints

- `POST /auth/login`: User authentication. Returns an `access_token`.
- `GET /auth/status`: Checks authentication status. Requires JWT.
- `POST /auth/2fa/generate`: Generates a QR code to set up 2FA. Requires JWT.
- `POST /auth/2fa/enable`: Enables 2FA using a code from the authenticator app. Requires JWT.
- `POST /auth/2fa/disable`: Disables 2FA. Requires JWT.
- `POST /auth/2fa/login`: Performs login with a 2FA code. Used after initial login if 2FA is enabled.

## Two-Factor Authentication (2FA)

### Activation Flow
1. User requests QR code generation (`/auth/2fa/generate`).
2. The API generates a secret and associates it with the user.
3. The API returns an `otpauth://` URL which is converted to a QR code on the frontend.
4. The user scans the QR code with an app (e.g., Google Authenticator).
5. The user sends the code generated by the app to (`/auth/2fa/enable`).
6. The API validates the code and enables 2FA for the user.

### Login Flow with 2FA
1. The user logs in with email and password (`/auth/login`).
2. If 2FA is enabled, the API returns a special status indicating the need for the second factor.
3. The user sends the 2FA code to (`/auth/2fa/login`).
4. The API validates the code and returns the final `access_token`.

## Security

- Passwords are stored hashed using `bcrypt`.
- JWT and 2FA secrets are stored in environment variables.
- The `access_token` has a short expiration time.

## How to Test

- Use the Postman collection (`/docs/postman_collection.json`) to test the flows.
- Create a user, log in, enable 2FA, and try to access protected routes.